CREATE TABLE ALUMNOS (
	IDALUMNO VARCHAR(10) NOT NULL PRIMARY KEY,
	NOMBRES VARCHAR(50) NOT NULL,
	PATERNO VARCHAR(50) NOT NULL,
	MATERNO VARCHAR(50) NOT NULL,
	FECHA DATE NOT NULL,
	TELEFONO VARCHAR(50));

CREATE TABLE PACIENTES (
	IDPACIENTE INT8 NOT NULL PRIMARY KEY,
	IDALUMNO VARCHAR(10) NOT NULL REFERENCES ALUMNOS,
	NOMBRES VARCHAR(50) NOT NULL,
	PATERNO VARCHAR(50) NOT NULL,
	MATERNO VARCHAR(50) NOT NULL,
	TELEFONO VARCHAR(50),
	FECHA_ALTA DATE NOT NULL,
	EDAD INTEGER NOT NULL,
	DIRECCION VARCHAR(256) NOT NULL,
	RIESGO_ASA INTEGER NOT NULL);

CREATE TABLE DOCTORES (
	IDDOCTOR SERIAL8 NOT NULL PRIMARY KEY,
	NOMBRES VARCHAR(50) NOT NULL,
	PATERNO VARCHAR(50) NOT NULL,
	MATERNO VARCHAR(50) NOT NULL,
	FECHA DATE NOT NULL,
	TELEFONO VARCHAR(50));

CREATE TABLE MATERIAS (
	IDMATERIA SERIAL8 NOT NULL PRIMARY KEY,
	NOMBRE_MATERIA VARCHAR(50) NOT NULL,
	FECHA DATE NOT NULL,
	GRADO INTEGER NOT NULL);

CREATE TABLE ARTICULOS (
	IDARTICULO VARCHAR(20) NOT NULL PRIMARY KEY,
	DESCRIPCION VARCHAR(256) NOT NULL,
	FECHA_ALTA DATE NOT NULL,
	COSTO_UNITARIO DECIMAL(7,2),
	EXISTENCIAS INT8 NOT NULL);

CREATE TABLE PAQUETES (
	IDPAQUETE VARCHAR(20) NOT NULL PRIMARY KEY,
	DESCRIPCION VARCHAR(256) NOT NULL,
	FECHA_ALTA DATE NOT NULL,
	COSTO_PAQUETE DECIMAL(7,2) NOT NULL);

CREATE TABLE DETALLEPAQUETES (
	IDDETALLE SERIAL8 NOT NULL PRIMARY KEY,
	IDPAQUETE VARCHAR(20) NOT NULL REFERENCES PAQUETES,
	IDARTICULO VARCHAR(20) NOT NULL REFERENCES ARTICULOS ON UPDATE CASCADE,
	CANTIDAD INTEGER NOT NULL);

CREATE TABLE VENTAS (
	IDVENTAS SERIAL8 NOT NULL PRIMARY KEY,
	IDALUMNO VARCHAR(10) NOT NULL REFERENCES ALUMNOS,
	IDPACIENTE INT8 NOT NULL,
	IDDOCTOR INT8 NOT NULL REFERENCES DOCTORES,
	IDMATERIA INT8 NOT NULL REFERENCES MATERIAS,
	FECHA_VENTA DATE NOT NULL,
	NUM_RECIBO VARCHAR(20) UNIQUE NOT NULL,
	SUBTOTAL DECIMAL(7,2),
	IVA DECIMAL(7,2),
	TOTAL DECIMAL(7,2) NOT NULL,
	LOGIN VARCHAR(20) NOT NULL);

CREATE TABLE CANCELACIONES (
	IDCANCELACIONES SERIAL8 NOT NULL PRIMARY KEY,
	IDVENTAS INT8 NOT NULL REFERENCES VENTAS,
	FECHA DATE NOT NULL,
	OBSERVACIONES VARCHAR(1024),
	LOGIN VARCHAR(20) NOT NULL);

CREATE TABLE DETALLEVENTAS (
	IDDETALLE SERIAL8 NOT NULL PRIMARY KEY,
	IDVENTAS INT8 NOT NULL REFERENCES VENTAS,
	IDARTICULO VARCHAR(20) NOT NULL,
	TIPOVENTA BOOL  NOT NULL,/*articulo=VERDADERO o paquete=FALSO  */
	COSTO_UNITARIO DECIMAL(7,2) NOT NULL,
	CANTIDAD_VENDIDA INTEGER NOT NULL,
	SUBTOTAL DECIMAL(7,2),
	IVA DECIMAL(7,2),
	TOTAL DECIMAL(7,2) NOT NULL,
	IDALMACEN INT8 NOT NULL);

CREATE TABLE BAJAS (
	IDBAJAS SERIAL8 NOT NULL PRIMARY KEY,
	IDARTICULO VARCHAR(20) NOT NULL REFERENCES ARTICULOS,
	TIPO_BAJA INTEGER NOT NULL, /* Consumo interno, caducidad, otros)*/
	FECHA_BAJA DATE NOT NULL,
	OBSERVACIONES VARCHAR(1024),
	CANTIDAD_BAJA INTEGER NOT NULL,
	LOGIN VARCHAR(20) NOT NULL
	IDALMACEN INT8 NOT NULL);

CREATE TABLE COMPRAS (
	IDCOMPRAS SERIAL8 NOT NULL PRIMARY KEY,
	NUMERO_RECIBO VARCHAR(30),
	FECHA_COMPRA DATE NOT NULL,
	SUBTOTAL DECIMAL(9,4) NOT NULL,
	IVA DECIMAL(9,4),
	TOTAL DECIMAL(9,4),
	LOGIN VARCHAR(20) NOT NULL);

CREATE TABLE DETALLECOMPRAS (
	IDDETALLE SERIAL8 NOT NULL PRIMARY KEY,
	IDCOMPRAS INT8 NOT NULL REFERENCES COMPRAS,
	IDARTICULO VARCHAR(20) NOT NULL REFERENCES ARTICULOS ON UPDATE CASCADE,
	CANTIDAD_COMPRADA INTEGER NOT NULL,
	COSTO_COMPRA_U DECIMAL(9,4) NOT NULL,
	SUBTOTAL DECIMAL(9,4),
	IVA DECIMAL(9,4),
	TOTAL DECIMAL(9,4) NOT NULL,
	IDALMACEN INT8 NOT NULL);

CREATE TABLE SOL_EXP_CLINICO (
	IDSOLICITUD SERIAL8 NOT NULL PRIMARY KEY,
	IDALUMNO VARCHAR(10) NOT NULL REFERENCES ALUMNOS,
	IDPACIENTE INT8 NOT NULL REFERENCES PACIENTES,
	IDDOCTOR INT8 NOT NULL REFERENCES DOCTORES,
	IDMATERIA INT8 NOT NULL REFERENCES MATERIAS,
	FECHA DATE NOT NULL,
	GRUPO VARCHAR(10),
	CUATRIMESTRE INTEGER,
	HORA_SALIDA TIME NOT NULL,
	HORA_ENTREGA TIME NOT NULL,
	LOGIN VARCHAR(20) NOT NULL);

CREATE TABLE ESTERILIZACION (
	IDESTERILIZACION SERIAL8 NOT NULL PRIMARY KEY,
	IDALUMNO VARCHAR(10) NOT NULL REFERENCES ALUMNOS,
	IDDOCTOR INT8 NOT NULL REFERENCES DOCTORES,
	GRUPO VARCHAR(10) NOT NULL,
	NUM_PAQUETES INTEGER NOT NULL,
	FECHA DATE NOT NULL,
	HORA_ENTRADA TIME NOT NULL,
	HORA_SALIDA TIME NOT NULL,
	LOGIN VARCHAR(20) NOT NULL);

CREATE TABLE CONFIGURACION (
	HOST VARCHAR(100) NOT NULL,
	NOMBREDB VARCHAR(20) NOT NULL,
	USUARIO VARCHAR(20) NOT NULL,
	PASSWORD VARCHAR(20) NOT NULL);

CREATE TABLE USUARIOS (
	LOGIN VARCHAR(20) NOT NULL PRIMARY KEY,
	PASSWORD VARCHAR(20) NOT NULL,
	NOMBRES VARCHAR(50) NOT NULL,
	PATERNO VARCHAR(50) NOT NULL,
	MATERNO VARCHAR(50) NOT NULL,
	NIVEL_ACCESO INTEGER NOT NULL);

CREATE TABLE ALMACENES(
	IDALMACEN SERIAL8 NOT NULL PRIMARY KEY,
	NOMBRE_ALM VARCHAR(50) NOT NULL UNIQUE,
	NUM_ALM INTEGER NOT NULL);

CREATE TABLE DETALLEALMACEN(
	IDDETALLE SERIAL8 NOT NULL PRIMARY KEY,
	IDALMACEN INT8 NOT NULL,
	IDARTICULO VARCHAR(20) NOT NULL,
	EXISTENCIAS INTEGER NOT NULL,
	FECHA DATE NOT NULL);

CREATE TABLE TRASPASOS(
	IDTRASPASO SERIAL8 NOT NULL PRIMARY KEY,
	IDALM_ORIGEN INT8 NOT NULL,
	IDALM_DESTINO INT8 NOT NULL,
	IDARTICULO VARCHAR(20) NOT NULL,
	CANTIDAD_TRASP INTEGER NOT NULL,
	FECHA DATE NOT NULL,
	LOGIN VARCHAR(20) NOT NULL);

CREATE OR REPLACE FUNCTION
IncrementaRecibo() RETURNS char
AS $$
DECLARE
strUltimo varchar;
intIncrementar int8;
BEGIN
	 select max(trim(both 'B' from num_recibo)) into strUltimo from ventas;
	intIncrementar=to_number(strUltimo,'99999999999999999999')+1;
	strUltimo:=trim(both from to_char(intIncrementar,'99999999999999999999'));
	strUltimo:='B'|| strUltimo;
	return strUltimo;
end;
$$ language plpgsql;

INSERT INTO USUARIOS VALUES('asierra','2010asc','ANTONIO','SIERRA','CHAVEZ',0);
INSERT INTO USUARIOS VALUES('elsa','ucad2010','ELSA','','',-1);
INSERT INTO USUARIOS VALUES('victor','ucad2010','VICTOR','','',-1);
INSERT INTO USUARIOS VALUES('miguel','ucad2010','MIGUEL','','',-1);
INSERT INTO USUARIOS VALUES('lichaucad','ucad2010','MARIA LUISA','','',-1);
INSERT INTO ARTICULOS VALUES('ACRILICO','ACRILICO (POLVO LIQUIDO)','2011-01-21',30.00,10);
INSERT INTO ARTICULOS VALUES('AGUAOXI','AGUA OXIGENADA(1/4)','2011-01-21',5.00,10);
INSERT INTO ARTICULOS VALUES('AGUJA','AGUJA','2011-01-21',2.0,10);
INSERT INTO ARTICULOS VALUES('AIINDIV','ALGINATO PARA IMPRESION INDIVIDUAL','2011-01-21',10.00,10);
INSERT INTO ARTICULOS VALUES('AISUPINF','ALGINATO PARA IMPRESION SUP-INF','2011-01-21',35.00,10);
INSERT INTO ARTICULOS VALUES('ALCOHOL','ALCOHOL(1/4)','2011-01-21',7.00,10);
INSERT INTO ARTICULOS VALUES('ALGODON','ALGODON (5 TORUNDAS)','2011-01-21',2.00,10);
INSERT INTO ARTICULOS VALUES('AMALINF','AMALGAMA INFANTIL','2011-01-21',100.00,10);
INSERT INTO ARTICULOS VALUES('AMALMAT','AMALGAMA CON MATERIAL','2011-01-21',135.00,10);
INSERT INTO ARTICULOS VALUES('ANESTESIA','ANESTESIA','2011-01-21',2.00,10);
INSERT INTO ARTICULOS VALUES('APFLUOR','APLICACION DE FLUOR','2011-01-21',50.00,10);
INSERT INTO ARTICULOS VALUES('ATENURGDOL','ATENCION DE URGENCIA CON DOLOR','2011-01-21',120.00,10);
INSERT INTO ARTICULOS VALUES('ATURG','ATENCION DE URGENCIA','2011-01-21',70.00,10);
INSERT INTO ARTICULOS VALUES('BABERO','BABERO','2011-01-21',2.00,10);
INSERT INTO ARTICULOS VALUES('BATACLI','BATA CLINICA','2011-01-21',20.00,10);
INSERT INTO ARTICULOS VALUES('BLANMAT','BLANCAMIENTO CON MATERIAL','2011-01-21',900.00,10);
INSERT INTO ARTICULOS VALUES('BLANUD','BLANCAMIENTO POR UNIDAD DENTAL','2011-01-21',150.00,10);
INSERT INTO ARTICULOS VALUES('CAMPO','CAMPO PARA INSTRUMENTAL','2011-01-21',2.00,10);
INSERT INTO ARTICULOS VALUES('CCARNET','CAMBIO DE CARNET','2011-01-21',15.00,10);
INSERT INTO ARTICULOS VALUES('CERATODAES','CERA TODA ESTACION','2011-01-21',3.00,10);
INSERT INTO ARTICULOS VALUES('CIRUGIA','CIRUGIA','2011-01-21',250.00,10);
INSERT INTO ARTICULOS VALUES('CONTPP','CONTROL PERSONAL DE PLACA','2011-01-21',25.00,10);
INSERT INTO ARTICULOS VALUES('CORACINF','CORONA DE ACERO CROMO INFANTIL','2011-01-21',140.00,10);
INSERT INTO ARTICULOS VALUES('CORMP','CORONA DE METAL PORCELANA','2011-01-21',270.00,10);
INSERT INTO ARTICULOS VALUES('CUBREBOCA','CUBRE BOCA','2011-01-21',1.00,10);
INSERT INTO ARTICULOS VALUES('CURAIRM','CURACION IRM-ZOE','2011-01-21',30.00,10);
INSERT INTO ARTICULOS VALUES('CURAIV','CURACION DE IONOMERO DE VIDRIO','2011-01-21',45.00,10);
INSERT INTO ARTICULOS VALUES('DHULE','DIQUE DE HULE','2011-01-21',6.00,10);
INSERT INTO ARTICULOS VALUES('DYCAL','DYCAL','2011-01-21',10.00,10);
INSERT INTO ARTICULOS VALUES('ELIMSARRO','ELIMINACION DE SARRO CON SAVITRON','2011-01-21',60.00,10);
INSERT INTO ARTICULOS VALUES('ENDOP','ENDÃ“OSTE CON DURALAY','2011-01-21',30.00,10);
INSERT INTO ARTICULOS VALUES('ENDOPOST','ENDODONCIA POSTERIORES','2011-01-21',240.00,10);
INSERT INTO ARTICULOS VALUES('ENDOUNI','ENDODONCIA UNIRRADICULARES','2011-01-21',120.00,10);
INSERT INTO ARTICULOS VALUES('EXTINTSUT','EXTRACCION INTERMEDIA CON SUTURA','2011-01-21',160.00,10);
INSERT INTO ARTICULOS VALUES('EXTRACCION','EXTRACCION','2011-01-21',80.00,10);
INSERT INTO ARTICULOS VALUES('EXTRACINF','EXTRACCION INFANTIL','2011-01-21',60.00,10);
INSERT INTO ARTICULOS VALUES('EXTRACUAD','EXTRACCION POR CUADRANTE','2011-01-21',350.00,10);
INSERT INTO ARTICULOS VALUES('GASA','GASA','2011-01-21',3.00,10);
INSERT INTO ARTICULOS VALUES('GINGIVECT','GINGIVECTOMIA Y PLASTIA CON CUADRANTE','2011-01-21',290.00,10);
INSERT INTO ARTICULOS VALUES('GORRO','GORRO QUIRURGICO','2011-01-21',6.00,10);
INSERT INTO ARTICULOS VALUES('GUANTES','GUANTES','2011-01-21',2.50,10);
INSERT INTO ARTICULOS VALUES('GUARDA','GUARDA OCLUSAL','2011-01-21',200.00,10);
INSERT INTO ARTICULOS VALUES('HBISTURI','HOJA DE BISTURI','2011-01-21',25.00,10);
INSERT INTO ARTICULOS VALUES('HC','HISTORIA CLINICA','2011-01-21',75.00,10);
INSERT INTO ARTICULOS VALUES('HCAPURO','HIDROXIDO DE CALCIO PURO','2011-01-21',5.00,10);
INSERT INTO ARTICULOS VALUES('IMPPSIL','IMPRESION PARCIAL CON SILICON','2011-01-21',30.00,10);
INSERT INTO ARTICULOS VALUES('IMPTOTSIL','IMPRESION TOTAL CON SILICON','2011-01-21',55.00,10);
INSERT INTO ARTICULOS VALUES('INLAYCER','INLAY CERAMINA','2011-01-21',270.00,10);
INSERT INTO ARTICULOS VALUES('INYECTOR','INYECTOR','2011-01-21',2.50,10);
INSERT INTO ARTICULOS VALUES('JUEGOTAB','JUEGO DE TABLILLAS DIENTES PROSTO','2011-01-21',280.00,10);
INSERT INTO ARTICULOS VALUES('MODELINA','MODELINA','2011-01-21',12.00,10);
INSERT INTO ARTICULOS VALUES('ONLAYMET','ONLAY DE METAL','2011-01-21',180.00,10);
INSERT INTO ARTICULOS VALUES('PALATRAY','HOJA DE PALATRAY','2011-01-21',50.00,10);
INSERT INTO ARTICULOS VALUES('PAQ4MAN','PAQUETE DE PROTECCION 4 MANOS','2011-01-21',30.00,10);
INSERT INTO ARTICULOS VALUES('PAQBAS','PAQUETE BASICO DE PROTECCION','2011-01-21',15.00,10);
INSERT INTO ARTICULOS VALUES('PAQPIJ','PAQUETE DE PROTECCION CON PIJAMA','2011-01-21',35.00,10);
INSERT INTO ARTICULOS VALUES('PORTCAN','PROTESIS FIJA CANINO-CANINO','2011-01-21',450.00,10);
INSERT INTO ARTICULOS VALUES('PROFFLUOR','PROFILAXIS CON APLICACION DE FLUOR','2011-01-21',65.00,10);
INSERT INTO ARTICULOS VALUES('PROFILAXIS','PROFILAXIS','2011-01-21',40.00,10);
INSERT INTO ARTICULOS VALUES('PROSTO','PROSTODONCIA TOTAL SUB-INF','2011-01-21',350.00,10);
INSERT INTO ARTICULOS VALUES('PROT3','PROTESIS FIJA 3 UNIDADES','2011-01-21',300.00,10);
INSERT INTO ARTICULOS VALUES('PROT4','PROTESIS FIJA POR CUADRANTE','2011-01-21',450.00,10);
INSERT INTO ARTICULOS VALUES('PROTREM','PROTESIS REMOVIBLE','2011-01-21',250.00,10);
INSERT INTO ARTICULOS VALUES('PULPECTOMI','PULPECTOMIA','2011-01-21',120.00,10);
INSERT INTO ARTICULOS VALUES('PULPOTOMIA','PULPOTOMIA','2011-01-21',100.00,10);
INSERT INTO ARTICULOS VALUES('RADIOG','RADIOGRAFIA','2011-01-21',8.00,10);
INSERT INTO ARTICULOS VALUES('RASPALI','RASPADOR Y ALIZADO RADICULAR','2011-01-21',140.00,10);
INSERT INTO ARTICULOS VALUES('RESINA','RESINA CON MATERIAL','2011-01-21',155.00,10);
INSERT INTO ARTICULOS VALUES('RESINAINF','RESINA INFANTIL','2011-01-21',100.00,10);
INSERT INTO ARTICULOS VALUES('SELLADORES','SELLADORES POR CUADRANTE','2011-01-21',290.00,10);
INSERT INTO ARTICULOS VALUES('SELLADORFI','SELLADOR DE FISURA POR UNIDAD','2011-01-21',70.00,10);
INSERT INTO ARTICULOS VALUES('SELLMASDOS','SELLADOR MAS DE DOS UNIDADES','2011-01-21',110.00,10);
INSERT INTO ARTICULOS VALUES('SERIERADIO','SERIE RADIOGRAFICA','2011-01-21',56.00,10);
INSERT INTO ARTICULOS VALUES('SUTURA','SUTURA','2011-01-21',25.00,10);
INSERT INTO ARTICULOS VALUES('TEMP_BOND','CURACION','2011-01-21',30.00,10);
INSERT INTO ARTICULOS VALUES('UNIDADPRO','UNIDAD ADICIONAL DE PROTESIS','2011-01-21',170.00,10);
INSERT INTO ARTICULOS VALUES('VASOAZUL','VASO AZUL','2011-01-21',2.50,10);
INSERT INTO ARTICULOS VALUES('YESOBELMIX','YESO BELMIX (PORCION INDIVIDUAL)','2011-01-21',10.00,10);
